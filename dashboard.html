<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位儀表板</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <!-- 自定義 CSS -->
    <style>
        body {
            background-color: #000; /* 黑色背景 */
            color: white; /* 全局文字顏色為白色 */
        }
        .stock-status {
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            background-color: #222;
            text-align: center; /* 文字置中 */
            width: 100%; /* 讓 Bootstrap 控制寬度 */
        }
        /* 表格樣式 */
        .indicator-table th, .indicator-table td {
            background-color: #333;
            color: white;
        }
        /* 狀態類別的樣式 */
        .status-buy {
            background-color: red;
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-sell {
            background-color: green;
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-wait {
            background-color: yellow;
            color: black;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-trend {
            background-color: pink; /* 粉紅色 */
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-hot-trend {
            background-color: violet; /* 淡紫色 */
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-no-trend {
            /* 無背景顏色，文字顏色為白色 */
            color: white;
            padding: 5px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        /* DataTables 排序指示符顏色調整 */
        table.dataTable thead .sorting:after,
        table.dataTable thead .sorting_asc:after,
        table.dataTable thead .sorting_desc:after {
            color: white; /* 調整排序指示符顏色為白色 */
        }
        table.dataTable thead .sorting:before,
        table.dataTable thead .sorting_asc:before,
        table.dataTable thead .sorting_desc:before {
            color: white; /* 調整排序指示符顏色為白色 */
        }
        /* 圖表高度 */
        #price-chart, #indicator-chart, #status-distribution-chart, #secondary-status-distribution-chart {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 回首頁按鈕 -->
        <div class="row mt-3">
            <div class="col-12 text-right">
                <a href="index.html" class="btn btn-primary">回首頁</a>
            </div>
        </div>

        <!-- 標題 -->
        <div class="row mt-4">
            <div class="col-12">
                <h1 class="text-center text-primary">Stock Dashboard</h1>
            </div>
        </div>

        <!-- 股票狀態概覽 -->
        <div class="row mt-4 justify-content-center" id="today-status">
            <!-- 動態生成的股票狀態將插入在這裡 -->
        </div>

        <!-- 選單 -->
        <div class="row mt-4">
            <div class="col-md-3 mb-3">
                <select id="interval-selection" class="form-control">
                    <option value="60m">60分鐘線</option>
                    <option value="1d" selected>日線</option>
                    <option value="1wk">週線</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="stock-ticker" class="form-control">
                    <option value="2330.TW">台積電</option>
                    <option value="00652.TW">富邦印度</option>
                    <option value="2454.TW">聯發科</option>
                    <option value="00679B.TWO">元大美債20年</option>
                    <option value="^TWII">台灣大盤指數</option>
                    <option value="TSLA">特斯拉</option>
                    <option value="NVDA">輝達</option>
                    <option value="MSFT">微軟</option>
                    <option value="AAPL">蘋果</option>
                    <option value="GOOG">谷歌</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="indicator-selection" class="form-control" multiple>
                    <optgroup label="移動平均線">
                        <option value="SMA">SMA (Simple Moving Average)</option>
                        <option value="EMA">EMA (Exponential Moving Average)</option>
                    </optgroup>
                    <optgroup label="波動率指標">
                        <option value="BB High" selected>BB High (布林帶上軌)</option>
                        <option value="BB Low" selected>BB Low (布林帶下軌)</option>
                    </optgroup>
                    <optgroup label="動量指標">
                        <option value="MACD">MACD (Moving Average Convergence Divergence)</option>
                        <option value="RSI">RSI (Relative Strength Index)</option>
                        <option value="Stochastic RSI">Stochastic RSI</option>
                        <option value="CCI">CCI (Commodity Channel Index)</option>
                        <option value="Williams %R">Williams %R</option>
                        <option value="ADX">ADX (Average Directional Index)</option>
                        <option value="K">K (Stochastic Oscillator)</option>
                        <option value="D">D (Stochastic Oscillator)</option>
                    </optgroup>
                    <optgroup label="價格指標">
                        <option value="Close Price" selected>Close Price (收盤價)</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="date-range-selection" class="form-control">
                    <option value="2m">近兩個月</option>
                    <option value="6m">近半年</option>
                    <option value="1y" selected>近一年</option>
                    <option value="3y">近三年</option>
                </select>
            </div>
        </div>

        <!-- 圖表 -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div id="price-chart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="indicator-chart"></div>
            </div>
        </div>

        <!-- 直方圖 -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div id="status-distribution-chart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="secondary-status-distribution-chart"></div>
            </div>
        </div>

        <!-- 表格 -->
        <div class="row mt-4">
            <div class="col-12">
                <table id="indicators-table" class="table table-striped table-bordered indicator-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Value</th>
                            <th>Sell Signal</th>
                            <th>Buy Signal</th>
                            <th>Secondary Sell Signal</th>
                            <th>Secondary Buy Signal</th>
                            <th>Status</th>
                            <th>Secondary Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 動態生成的表格數據將插入在這裡 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 引入 DataTables.js -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
    <!-- 引入 Bootstrap JS 和依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- 引入 Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- 自定義 JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 DataTable
            var table = $('#indicators-table').DataTable({
                "paging": false,
                "info": false,
                "autoWidth": false,
                "order": [], // 禁用初始排序
                "columnDefs": [
                    {
                        "targets": [6, 7], // Status 和 Secondary Status 欄位
                        "render": function(data, type, row, meta) {
                            if(type === 'sort') {
                                // 提取純文本內容進行排序
                                return $(data).text();
                            }
                            return data;
                        }
                    }
                ]
            });

            // 股票代碼映射 (更新後：移除永豐ESG，加入美股)
            const tickers = {
                '台積電': '2330.TW',
                '富邦印度': '00652.TW',
                '聯發科': '2454.TW',
                '元大美債20年': '00679B.TWO',
                '台灣大盤指數': '^TWII',
                '特斯拉': 'TSLA',
                '輝達': 'NVDA',
                '微軟': 'MSFT',
                '蘋果': 'AAPL',
                '谷歌': 'GOOG'
            };

            // 監聽選擇變更
            $('#interval-selection, #stock-ticker, #indicator-selection, #date-range-selection').on('change', function() {
                updateDashboard();
            });

            // 初始加載
            updateDashboard();

            function updateDashboard() {
                const interval = $('#interval-selection').val();
                const ticker = $('#stock-ticker').val();
                const selectedIndicators = $('#indicator-selection').val() || [];
                const dateRange = $('#date-range-selection').val();

                fetch(`data/stock_data.json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 根據選擇的股票和日期範圍過濾數據
                        let filteredData = filterData(data, ticker, dateRange, interval);
                        if (filteredData.length === 0) {
                            alert('沒有符合條件的數據。');
                            return;
                        }

                        // 獲取最新一筆數據
                        const latestEntry = filteredData[filteredData.length - 1];
                        const previousEntry = filteredData[filteredData.length - 2] || {};

                        // 更新表格
                        updateTable(latestEntry, previousEntry, data);

                        // 更新圖表
                        updateCharts(filteredData, selectedIndicators);

                        // 更新今日狀態
                        updateTodayStatus(data, tickers);
                    })
                    .catch(error => {
                        console.error('無法加載數據:', error);
                        alert('無法加載數據。請檢查控制台以獲取更多信息。');
                    });
            }

            function filterData(data, ticker, dateRange, interval) {
                // 過濾特定股票
                let tickerData = data.filter(entry => entry.ticker === ticker);

                if (tickerData.length === 0) {
                    return [];
                }

                // 解析日期並排序
                tickerData.forEach(entry => {
                    entry.Date = new Date(entry.Date);
                });
                tickerData.sort((a, b) => a.Date - b.Date);

                // 根據日期範圍過濾
                const today = new Date();
                let startDate = new Date(today); // 創建 today 的副本
                switch(dateRange) {
                    case '2m':
                        startDate.setMonth(startDate.getMonth() - 2);
                        break;
                    case '6m':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '3y':
                        startDate.setFullYear(startDate.getFullYear() - 3);
                        break;
                    case '1y':
                    default:
                        startDate.setFullYear(startDate.getFullYear() - 1);
                }

                // 過濾日期範圍
                tickerData = tickerData.filter(entry => entry.Date >= startDate && entry.Date <= today);

                // 根據 interval 過濾
                if (interval === '1wk') {
                    // 每週一取一筆數據
                    tickerData = tickerData.filter(entry => entry.Date.getDay() === 1); // 0=Sunday, 1=Monday, etc.
                } else if (interval === '60m') {
                    // 假設有更高頻率的數據，否則無法處理
                    // 目前數據為日線，忽略
                }
                // 其他間隔可以根據需要實現

                return tickerData;
            }

            function updateTable(latestEntry, previousEntry, data) {
                // 清空表格
                table.clear();

                // 提取指標值
                const indicators = {
                    "MACD": latestEntry.MACD !== null ? latestEntry.MACD : "-",
                    "MACD_signal": latestEntry.MACD_signal !== null ? latestEntry.MACD_signal : "-",
                    "RSI": latestEntry.RSI !== null ? latestEntry.RSI : "-",
                    "SMA": latestEntry.SMA !== null ? latestEntry.SMA : "-",
                    "EMA": latestEntry.EMA !== null ? latestEntry.EMA : "-",
                    "BB High": latestEntry['BB High'] !== null ? latestEntry['BB High'] : "-",
                    "BB Low": latestEntry['BB Low'] !== null ? latestEntry['BB Low'] : "-",
                    "K": latestEntry.K !== null ? latestEntry.K : "-",
                    "D": latestEntry.D !== null ? latestEntry.D : "-",
                    "Stochastic RSI": latestEntry['Stochastic RSI'] !== null ? latestEntry['Stochastic RSI'] : "-",
                    "CCI": latestEntry.CCI !== null ? latestEntry.CCI : "-",
                    "Williams %R": latestEntry['Williams %R'] !== null ? latestEntry['Williams %R'] : "-",
                    "ADX": latestEntry.ADX !== null ? latestEntry.ADX : "-",
                    "Close Price": latestEntry.Close !== null ? latestEntry.Close : "-"
                };

                // 評估信號
                const indicatorValues = evaluateSignals(indicators);

                // 更新狀態分佈直方圖
                updateStatusCharts(indicatorValues);

                // 遍歷指標並添加到表格
                indicatorValues.forEach(indicator => {
                    table.row.add([
                        indicator.Indicator,
                        indicator.Value,
                        indicator['Sell Signal'],
                        indicator['Buy Signal'],
                        indicator['Secondary Sell Signal'],
                        indicator['Secondary Buy Signal'],
                        indicator.Status, // 包含 span 元素或純文本
                        indicator['Secondary Status'] // 包含 span 元素或純文本
                    ]);
                });

                // 調試：在控制台輸出要添加到表格的數據
                console.log("Table Rows to Add:", indicatorValues);

                // 重新繪製表格
                table.draw();
            }

            function evaluateSignals(indicators) {
                const indicator_values = [];

                // Helper function to safely format numbers
                function formatNumber(value) {
                    return (value !== null && value !== undefined && !isNaN(value)) ? parseFloat(value).toFixed(2) : '-';
                }

                // MACD
                const macd = indicators["MACD"];
                const macd_signal = indicators["MACD_signal"];
                let status_macd = "Wait";
                let secondary_status_macd = "Wait";
                if (macd > macd_signal) {
                    status_macd = "Buy";
                    secondary_status_macd = "Buy";
                } else if (macd < macd_signal) {
                    status_macd = "Sell";
                    secondary_status_macd = "Sell";
                }

                indicator_values.push({
                    "Indicator": "MACD",
                    "Value": formatNumber(macd),
                    "Sell Signal": `< ${formatNumber(macd_signal)}`,
                    "Buy Signal": `> ${formatNumber(macd_signal)}`,
                    "Secondary Sell Signal": `< ${formatNumber(macd_signal)}`,
                    "Secondary Buy Signal": `> ${formatNumber(macd_signal)}`,
                    "Status": `<span class="${statusClass_general(status_macd.toLowerCase())}">${status_macd}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_macd.toLowerCase())}">${secondary_status_macd}</span>`
                });

                // RSI
                const rsi = indicators["RSI"];
                indicator_values.push({
                    "Indicator": "RSI",
                    "Value": formatNumber(rsi),
                    "Sell Signal": "> 70",
                    "Buy Signal": "< 30",
                    "Secondary Sell Signal": "> 60",
                    "Secondary Buy Signal": "< 40",
                    "Status": determineStatus(rsi, 70, 30, 60, 40),
                    "Secondary Status": determineSecondaryStatus(rsi, 70, 30, 60, 40)
                });

                // SMA
                const sma = indicators["SMA"];
                const close_price_sma = indicators["Close Price"];
                let status_sma = "Wait";
                let secondary_status_sma = "Wait";
                if (close_price_sma < sma) {
                    status_sma = "Buy";
                    secondary_status_sma = "Buy";
                } else if (close_price_sma > sma) {
                    status_sma = "Sell";
                    secondary_status_sma = "Sell";
                }

                indicator_values.push({
                    "Indicator": "SMA",
                    "Value": formatNumber(sma),
                    "Sell Signal": `< ${formatNumber(close_price_sma)}`,
                    "Buy Signal": `> ${formatNumber(close_price_sma)}`,
                    "Secondary Sell Signal": `< ${formatNumber(close_price_sma)}`,
                    "Secondary Buy Signal": `> ${formatNumber(close_price_sma)}`,
                    "Status": `<span class="${statusClass_general(status_sma.toLowerCase())}">${status_sma}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_sma.toLowerCase())}">${secondary_status_sma}</span>`
                });

                // EMA
                const ema = indicators["EMA"];
                const close_price_ema = indicators["Close Price"];
                let status_ema = "Wait";
                let secondary_status_ema = "Wait";
                if (close_price_ema < ema) {
                    status_ema = "Buy";
                    secondary_status_ema = "Buy";
                } else if (close_price_ema > ema) {
                    status_ema = "Sell";
                    secondary_status_ema = "Sell";
                }

                indicator_values.push({
                    "Indicator": "EMA",
                    "Value": formatNumber(ema),
                    "Sell Signal": `< ${formatNumber(close_price_ema)}`,
                    "Buy Signal": `> ${formatNumber(close_price_ema)}`,
                    "Secondary Sell Signal": `< ${formatNumber(close_price_ema)}`,
                    "Secondary Buy Signal": `> ${formatNumber(close_price_ema)}`,
                    "Status": `<span class="${statusClass_general(status_ema.toLowerCase())}">${status_ema}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_ema.toLowerCase())}">${secondary_status_ema}</span>`
                });

                // Bollinger Bands High v.s Close Price
                const bb_high = indicators["BB High"];
                const bb_low = indicators["BB Low"];
                const close_price_bb_high = indicators["Close Price"];
                const near_low = bb_low + (bb_high - bb_low) / 10;
                const near_high = bb_high - (bb_high - bb_low) / 10;

                let status_bb_high = "Wait";
                let secondary_status_bb_high = "Wait";

                if (close_price_bb_high < bb_low) {
                    status_bb_high = "Buy";
                } else if (close_price_bb_high < near_low) {
                    secondary_status_bb_high = "Buy";
                }

                if (close_price_bb_high > bb_high) {
                    status_bb_high = "Sell";
                } else if (close_price_bb_high > near_high) {
                    secondary_status_bb_high = "Sell";
                }

                indicator_values.push({
                    "Indicator": "BB High v.s Close Price",
                    "Value": formatNumber(close_price_bb_high),
                    "Sell Signal": `> ${formatNumber(bb_high)}`,
                    "Buy Signal": `> ${formatNumber(bb_low)}`,
                    "Secondary Sell Signal": `< ${formatNumber(near_high)}`,
                    "Secondary Buy Signal": `> ${formatNumber(near_low)}`,
                    "Status": `<span class="${statusClass_general(status_bb_high.toLowerCase().replace(' ', '-'))}">${status_bb_high}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_bb_high.toLowerCase().replace(' ', '-'))}">${secondary_status_bb_high}</span>`
                });

                // Bollinger Bands Low v.s Close Price
                let status_bb_low = "Wait";
                let secondary_status_bb_low = "Wait";

                if (close_price_bb_high < bb_low) {
                    status_bb_low = "Buy";
                } else if (close_price_bb_high < near_low) {
                    secondary_status_bb_low = "Buy";
                }

                if (close_price_bb_high > bb_high) {
                    status_bb_low = "Sell";
                } else if (close_price_bb_high > near_high) {
                    secondary_status_bb_low = "Sell";
                }

                indicator_values.push({
                    "Indicator": "BB Low v.s Close Price",
                    "Value": formatNumber(close_price_bb_high),
                    "Sell Signal": `> ${formatNumber(bb_high)}`,
                    "Buy Signal": `< ${formatNumber(bb_low)}`,
                    "Secondary Sell Signal": `< ${formatNumber(near_high)}`,
                    "Secondary Buy Signal": `< ${formatNumber(near_low)}`,
                    "Status": `<span class="${statusClass_general(status_bb_low.toLowerCase().replace(' ', '-'))}">${status_bb_low}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_bb_low.toLowerCase().replace(' ', '-'))}">${secondary_status_bb_low}</span>`
                });

                // Stochastic RSI
                const stochastic_rsi = indicators["Stochastic RSI"];
                indicator_values.push({
                    "Indicator": "Stochastic RSI",
                    "Value": formatNumber(stochastic_rsi),
                    "Sell Signal": "> 80",
                    "Buy Signal": "< 20",
                    "Secondary Sell Signal": "> 60",
                    "Secondary Buy Signal": "< 40",
                    "Status": determineStatus(stochastic_rsi, 80, 20, 60, 40),
                    "Secondary Status": determineSecondaryStatus(stochastic_rsi, 80, 20, 60, 40)
                });

                // CCI
                const cci = indicators["CCI"];
                indicator_values.push({
                    "Indicator": "CCI",
                    "Value": formatNumber(cci),
                    "Sell Signal": "> 100",
                    "Buy Signal": "< -100",
                    "Secondary Sell Signal": "> 90",
                    "Secondary Buy Signal": "< -90",
                    "Status": determineStatus(cci, 100, -100, 90, -90),
                    "Secondary Status": determineSecondaryStatus(cci, 100, -100, 90, -90)
                });

                // Williams %R
                const williams_r = indicators["Williams %R"];
                indicator_values.push({
                    "Indicator": "Williams %R",
                    "Value": formatNumber(williams_r),
                    "Sell Signal": "> -20",
                    "Buy Signal": "< -80",
                    "Secondary Sell Signal": "> -40",
                    "Secondary Buy Signal": "< -60",
                    "Status": determineStatus(williams_r, -20, -80, -40, -60),
                    "Secondary Status": determineSecondaryStatus(williams_r, -20, -80, -40, -60)
                });

                // ADX
                const adx = indicators["ADX"];
                let status_adx = "Wait";
                let secondary_status_adx = "Wait";

                if (adx > 25) {
                    status_adx = "Hot Trend";
                    secondary_status_adx = "Hot Trend";
                } else if (adx < 20) {
                    status_adx = "No Trend";
                    secondary_status_adx = "No Trend";
                }

                indicator_values.push({
                    "Indicator": "ADX",
                    "Value": formatNumber(adx),
                    "Sell Signal": "< 20",
                    "Buy Signal": "> 25",
                    "Secondary Sell Signal": "< 20",
                    "Secondary Buy Signal": "> 25",
                    "Status": `<span class="${statusClass_general(status_adx.toLowerCase().replace(' ', '-'))}">${status_adx}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_adx.toLowerCase().replace(' ', '-'))}">${secondary_status_adx}</span>`
                });

                // K
                const k = indicators["K"];
                const d = indicators["D"];
                let status_k = "Wait";
                let secondary_status_k = "Wait";

                if (k < 20 && d < 20 && k > d) {
                    status_k = "Buy";
                }
                if (k < 30 && d < 30 && k > d) {
                    secondary_status_k = "Buy";
                }
                if (k > 80 && d > 80 && k < d) {
                    status_k = "Sell";
                }
                if (k > 70 && d > 70 && k < d) {
                    secondary_status_k = "Sell";
                }

                indicator_values.push({
                    "Indicator": "K",
                    "Value": formatNumber(k),
                    "Sell Signal": "> 80",
                    "Buy Signal": "< 20",
                    "Secondary Sell Signal": "> 70",
                    "Secondary Buy Signal": "< 30",
                    "Status": `<span class="${statusClass_general(status_k.toLowerCase())}">${status_k}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_k.toLowerCase())}">${secondary_status_k}</span>`
                });

                // D
                let status_d = "Wait";
                let secondary_status_d = "Wait";

                if (k < 20 && d < 20 && k > d) {
                    status_d = "Buy";
                }
                if (k < 30 && d < 30 && k > d) {
                    secondary_status_d = "Buy";
                }
                if (k > 80 && d > 80 && k < d) {
                    status_d = "Sell";
                }
                if (k > 70 && d > 70 && k < d) {
                    secondary_status_d = "Sell";
                }

                indicator_values.push({
                    "Indicator": "D",
                    "Value": formatNumber(d),
                    "Sell Signal": "> 80",
                    "Buy Signal": "< 20",
                    "Secondary Sell Signal": "> 70",
                    "Secondary Buy Signal": "< 30",
                    "Status": `<span class="${statusClass_general(status_d.toLowerCase())}">${status_d}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_d.toLowerCase())}">${secondary_status_d}</span>`
                });

                // Close Price
                const close_price_val = indicators["Close Price"];
                indicator_values.push({
                    "Indicator": "Close Price",
                    "Value": formatNumber(close_price_val),
                    "Sell Signal": "-",
                    "Buy Signal": "-",
                    "Secondary Sell Signal": "-",
                    "Secondary Buy Signal": "-",
                    "Status": "-",
                    "Secondary Status": "-"
                });

                // 調試：在控制台輸出所有指標值
                console.log("Evaluated Indicators:", indicator_values);

                return indicator_values;
            }

            // 判斷一般指標的 Status
            function determineStatus(value, sellSignal, buySignal, secondarySell, secondaryBuy) {
                if (value > sellSignal) {
                    return `<span class="${statusClass_general('sell')}">Sell</span>`;
                } else if (value < buySignal) {
                    return `<span class="${statusClass_general('buy')}">Buy</span>`;
                } else {
                    return `<span class="${statusClass_general('wait')}">Wait</span>`;
                }
            }

            // 判斷一般指標的 Secondary Status
            function determineSecondaryStatus(value, sellSignal, buySignal, secondarySell, secondaryBuy) {
                if (value > secondarySell) {
                    return `<span class="${statusClass_general('sell')}">Sell</span>`;
                } else if (value < secondaryBuy) {
                    return `<span class="${statusClass_general('buy')}">Buy</span>`;
                } else {
                    return `<span class="${statusClass_general('wait')}">Wait</span>`;
                }
            }

            // 輔助函數來獲取狀態類別
            function statusClass_general(status) {
                switch(status.toLowerCase()) {
                    case 'buy':
                        return 'status-buy';
                    case 'sell':
                        return 'status-sell';
                    case 'wait':
                        return 'status-wait';
                    case 'trend':
                        return 'status-trend';
                    case 'hot-trend':
                        return 'status-hot-trend';
                    case 'no-trend':
                        return 'status-no-trend';
                    default:
                        return 'status-wait';
                }
            }

            function updateCharts(data, selectedIndicators) {
                // 準備數據
                const dates = data.map(entry => entry.Date.toISOString().split('T')[0]);
                const closePrices = data.map(entry => entry.Close);

                // 繪製收盤價圖表（左側）僅顯示折線
                let priceTraces = [{
                    x: dates,
                    y: closePrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: '收盤價',
                    line: { color: '#17BECF' }
                }];

                // Plotly layout for price chart
                let priceLayout = {
                    title: '股票收盤價',
                    xaxis: { title: '日期' },
                    yaxis: { title: '價格 (TWD)' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // 繪製技術指標圖表（右側）
                let indicatorTraces = [];

                selectedIndicators.forEach(indicator => {
                    if (indicator === "MACD") {
                        const macd = data.map(entry => entry.MACD !== null ? entry.MACD : null);
                        const macd_signal = data.map(entry => entry.MACD_signal !== null ? entry.MACD_signal : null);
                        indicatorTraces.push({
                            x: dates,
                            y: macd,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: macd_signal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD Signal',
                            line: { color: '#2ECC40' }
                        });
                    }
                    if (indicator === "RSI") {
                        const rsi = data.map(entry => entry.RSI !== null ? entry.RSI : null);
                        indicatorTraces.push({
                            x: dates,
                            y: rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(70),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(30),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "SMA") {
                        const sma = data.map(entry => entry.SMA !== null ? entry.SMA : null);
                        indicatorTraces.push({
                            x: dates,
                            y: sma,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'SMA',
                            line: { color: '#FFA500' }
                        });
                    }
                    if (indicator === "EMA") {
                        const ema = data.map(entry => entry.EMA !== null ? entry.EMA : null);
                        indicatorTraces.push({
                            x: dates,
                            y: ema,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'EMA',
                            line: { color: '#800080' }
                        });
                    }
                    if (indicator === "BB High") {
                        const bb_high = data.map(entry => entry['BB High'] !== null ? entry['BB High'] : null);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_high,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB High',
                            line: { color: '#FFFF00' }
                        });
                    }
                    if (indicator === "BB Low") {
                        const bb_low = data.map(entry => entry['BB Low'] !== null ? entry['BB Low'] : null);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_low,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Low',
                            line: { color: '#00FF00' }
                        });
                    }
                    if (indicator === "K") {
                        const k = data.map(entry => entry.K !== null ? entry.K : null);
                        indicatorTraces.push({
                            x: dates,
                            y: k,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K',
                            line: { color: '#FF69B4' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "D") {
                        const d = data.map(entry => entry.D !== null ? entry.D : null);
                        indicatorTraces.push({
                            x: dates,
                            y: d,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D',
                            line: { color: '#1E90FF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Stochastic RSI") {
                        const stochastic_rsi = data.map(entry => entry['Stochastic RSI'] !== null ? entry['Stochastic RSI'] : null);
                        indicatorTraces.push({
                            x: dates,
                            y: stochastic_rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI',
                            line: { color: '#DC143C' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "CCI") {
                        const cci = data.map(entry => entry.CCI !== null ? entry.CCI : null);
                        indicatorTraces.push({
                            x: dates,
                            y: cci,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI',
                            line: { color: '#00FFFF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Williams %R") {
                        const williams_r = data.map(entry => entry['Williams %R'] !== null ? entry['Williams %R'] : null);
                        indicatorTraces.push({
                            x: dates,
                            y: williams_r,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R',
                            line: { color: '#8B008B' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-40),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "ADX") {
                        const adx = data.map(entry => entry.ADX !== null ? entry.ADX : null);
                        indicatorTraces.push({
                            x: dates,
                            y: adx,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'ADX',
                            line: { color: '#FFD700' }
                        });
                        // ADX 信號可以更複雜，這裡僅顯示 ADX 線
                    }
                    if (indicator === "Close Price") {
                        const closePrices = data.map(entry => entry.Close !== null ? entry.Close : null);
                        indicatorTraces.push({
                            x: dates,
                            y: closePrices,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Close Price',
                            line: { color: '#17BECF'}
                        });
                    }
                });

                // Plotly layout for indicator chart
                let indicatorLayout = {
                    title: '技術指標',
                    xaxis: { title: '日期' },
                    yaxis: { title: '值' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // 繪製收盤價圖表
                Plotly.newPlot('price-chart', priceTraces, priceLayout);

                // 繪製技術指標圖表
                if (indicatorTraces.length > 0) {
                    Plotly.newPlot('indicator-chart', indicatorTraces, indicatorLayout);
                } else {
                    // 如果未選擇任何指標，顯示空白或提示
                    Plotly.purge('indicator-chart');
                    Plotly.newPlot('indicator-chart', [], indicatorLayout);
                }
            }

            function updateStatusCharts(indicatorValues) {
                let statusCounts = { 'Buy': 0, 'Wait': 0, 'Sell': 0 };
                let secondaryStatusCounts = { 'Buy': 0, 'Wait': 0, 'Sell': 0 };

                indicatorValues.forEach(indicator => {
                    // 提取 Status 和 Secondary Status 的文字內容
                    let statusText = $(indicator.Status).text();
                    let secondaryStatusText = $(indicator['Secondary Status']).text();

                    if (statusText in statusCounts) {
                        statusCounts[statusText]++;
                    }
                    if (secondaryStatusText in secondaryStatusCounts) {
                        secondaryStatusCounts[secondaryStatusText]++;
                    }
                });

                // 創建 Status 分佈直方圖數據
                const statusData = [{
                    x: ['Buy', 'Wait', 'Sell'],
                    y: [statusCounts['Buy'], statusCounts['Wait'], statusCounts['Sell']],
                    type: 'bar',
                    marker: {
                        color: [
                            'rgba(255, 0, 0, 0.8)',    // Buy - 半透明紅色 (透明度 0.8)
                            'rgba(255, 255, 0, 0.5)',  // Wait - 半透明黃色 (透明度 0.5)
                            'rgba(0, 128, 0, 0.8)'     // Sell - 半透明綠色 (透明度 0.8)
                        ]
                    },
                    text: [statusCounts['Buy'], statusCounts['Wait'], statusCounts['Sell']],
                    textposition: 'auto',
                    textfont: { color: 'white' }, // 將數值顏色設為白色
                    hoverinfo: 'text+y'
                }];

                const statusLayout = {
                    title: 'Status 分佈',
                    xaxis: { title: '狀態' },
                    yaxis: { title: '數量' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    showlegend: false,
                    hovermode: 'closest'
                };

                // 創建 Secondary Status 分佈直方圖數據
                const secondaryStatusData = [{
                    x: ['Buy', 'Wait', 'Sell'],
                    y: [secondaryStatusCounts['Buy'], secondaryStatusCounts['Wait'], secondaryStatusCounts['Sell']],
                    type: 'bar',
                    marker: {
                        color: [
                            'rgba(255, 0, 0, 0.8)',    // Buy - 半透明紅色 (透明度 0.8)
                            'rgba(255, 255, 0, 0.5)',  // Wait - 半透明黃色 (透明度 0.5)
                            'rgba(0, 128, 0, 0.8)'     // Sell - 半透明綠色 (透明度 0.8)
                        ]
                    },
                    text: [secondaryStatusCounts['Buy'], secondaryStatusCounts['Wait'], secondaryStatusCounts['Sell']],
                    textposition: 'auto',
                    textfont: { color: 'white' }, // 將數值顏色設為白色
                    hoverinfo: 'text+y'
                }];

                const secondaryStatusLayout = {
                    title: 'Secondary Status 分佈',
                    xaxis: { title: '狀態' },
                    yaxis: { title: '數量' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    showlegend: false,
                    hovermode: 'closest'
                };

                // 繪製 Status 分佈直方圖
                Plotly.newPlot('status-distribution-chart', statusData, statusLayout);

                // 繪製 Secondary Status 分佈直方圖
                Plotly.newPlot('secondary-status-distribution-chart', secondaryStatusData, secondaryStatusLayout);
            }

            function updateTodayStatus(data, tickers) {
                // 清空現有狀態
                $('#today-status').empty();

                const todayStatuses = [];

                Object.keys(tickers).forEach(name => {
                    const ticker = tickers[name];
                    const tickerData = data.filter(entry => entry.ticker === ticker);
                    if (tickerData.length === 0) {
                        todayStatuses.push(`
                            <div class="col-md-2 col-sm-6 stock-status">
                                <p style="font-weight:bold; font-size:18px;">${name}</p>
                                <p>No data available</p>
                            </div>
                        `);
                        return;
                    }

                    const latestEntry = tickerData[tickerData.length - 1];
                    const previousEntry = tickerData[tickerData.length - 2] || {};

                    const latestClose = parseFloat(latestEntry.Close);
                    const previousClose = previousEntry.Close !== null && previousEntry.Close !== undefined ? parseFloat(previousEntry.Close) : latestClose;
                    const change = latestClose - previousClose;
                    const changePercent = ((change) / previousClose) * 100;

                    let color, changeText, changeAmount;
                    if (change > 0) {
                        color = 'lightcoral'; // 淡紅色
                        changeText = `↑ ${changePercent.toFixed(2)}%`;
                        changeAmount = `+${change.toFixed(2)}`;
                    } else if (change < 0) {
                        color = 'lightgreen'; // 淡綠色
                        changeText = `↓ ${Math.abs(changePercent).toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    } else {
                        color = 'white';
                        changeText = `${changePercent.toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    }

                    todayStatuses.push(`
                        <div class="col-md-2 col-sm-6 stock-status">
                            <p style="font-weight:bold; font-size:18px;">${name}</p>
                            <p>股價: $${latestClose.toFixed(2)}</p>
                            <p style="color:${color};">${changeAmount}</p>
                            <p style="color:${color};">${changeText}</p>
                        </div>
                    `);
                });

                $('#today-status').html(`
                    <div class="w-100 d-flex justify-content-center flex-wrap">
                        ${todayStatuses.join('')}
                    </div>
                `);
            }
        });
    </script>
</body>
</html>