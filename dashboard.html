<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位儀表板</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <!-- 自定義 CSS -->
    <style>
        body {
            background-color: #000; /* 黑色背景 */
            color: white; /* 全局文字顏色為白色 */
        }
        .stock-status {
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            background-color: #222;
            text-align: center; /* 文字置中 */
            width: 100%; /* 讓 Bootstrap 控制寬度 */
        }
        /* 表格樣式 */
        .indicator-table th, .indicator-table td {
            background-color: #333;
            color: white;
        }
        /* 狀態類別的樣式 */
        .status-buy {
            background-color: red;
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        .status-sell {
            background-color: green;
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        .status-wait {
            background-color: yellow;
            color: black;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        .status-trend {
            background-color: pink; /* 粉紅色 */
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        .status-hot-trend {
            background-color: violet; /* 淡紫色 */
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        /* DataTables 排序指示符顏色調整 */
        table.dataTable thead .sorting:after,
        table.dataTable thead .sorting_asc:after,
        table.dataTable thead .sorting_desc:after {
            color: white; /* 調整排序指示符顏色為白色 */
        }

        table.dataTable thead .sorting:before,
        table.dataTable thead .sorting_asc:before,
        table.dataTable thead .sorting_desc:before {
            color: white; /* 調整排序指示符顏色為白色 */
        }

        /* 圖表高度 */
        #price-chart, #indicator-chart {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 回首頁按鈕 -->
        <div class="row mt-3">
            <div class="col-12 text-right">
                <a href="index.html" class="btn btn-primary">回首頁</a>
            </div>
        </div>

        <!-- 標題 -->
        <div class="row mt-4">
            <div class="col-12">
                <h1 class="text-center text-primary">Stock Dashboard</h1>
            </div>
        </div>

        <!-- 六檔股票的概覽 -->
        <div class="row mt-4 justify-content-center" id="today-status">
            <!-- 動態生成的股票狀態將插入在這裡 -->
        </div>

        <!-- 選單 -->
        <div class="row mt-4">
            <div class="col-md-3 mb-3">
                <select id="interval-selection" class="form-control">
                    <option value="60m">60分鐘線</option>
                    <option value="1d" selected>日線</option>
                    <option value="1wk">週線</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="stock-ticker" class="form-control">
                    <option value="2330.TW">台積電</option>
                    <option value="00652.TW">富邦印度</option>
                    <option value="00930.TW">永豐ESG</option>
                    <option value="2454.TW">聯發科</option>
                    <option value="00679B.TWO">元大美債20年</option>
                    <option value="^TWII">台灣大盤指數</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="indicator-selection" class="form-control" multiple>
                    <optgroup label="移動平均線">
                        <option value="SMA">SMA (Simple Moving Average)</option>
                        <option value="EMA">EMA (Exponential Moving Average)</option>
                    </optgroup>
                    <optgroup label="波動率指標">
                        <option value="BB High">BB High (布林帶上軌)</option>
                        <option value="BB Low">BB Low (布林帶下軌)</option>
                    </optgroup>
                    <optgroup label="動量指標">
                        <option value="MACD">MACD (Moving Average Convergence Divergence)</option>
                        <option value="RSI">RSI (Relative Strength Index)</option>
                        <option value="Stochastic RSI">Stochastic RSI</option>
                        <option value="CCI">CCI (Commodity Channel Index)</option>
                        <option value="Williams %R">Williams %R</option>
                        <option value="ADX">ADX (Average Directional Index)</option>
                        <option value="K">K (Stochastic Oscillator)</option>
                        <option value="D">D (Stochastic Oscillator)</option>
                    </optgroup>
                    <optgroup label="價格指標">
                        <option value="Close Price">Close Price (收盤價)</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="date-range-selection" class="form-control">
                    <option value="2m">近兩個月</option>
                    <option value="6m">近半年</option>
                    <option value="1y" selected>近一年</option>
                    <option value="3y">近三年</option>
                </select>
            </div>
        </div>

        <!-- 圖表 -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div id="price-chart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="indicator-chart"></div>
            </div>
        </div>

        <!-- 表格 -->
        <div class="row mt-4">
            <div class="col-12">
                <table id="indicators-table" class="table table-striped table-bordered indicator-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Value</th>
                            <th>Sell Signal</th>
                            <th>Buy Signal</th>
                            <th>Secondary Sell Signal</th>
                            <th>Secondary Buy Signal</th>
                            <th>Status</th>
                            <th>Secondary Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 動態生成的表格數據將插入在這裡 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 引入 DataTables.js -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
    <!-- 引入 Bootstrap JS 和依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- 引入 Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- 自定義 JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 DataTable
            var table = $('#indicators-table').DataTable({
                "paging": false,
                "info": false,
                "autoWidth": false,
                "order": [], // 如果您希望禁用初始排序，保留此行
                // 移除 columnDefs 部分，允許所有欄位進行排序和搜索
            });

            // 股票代碼映射
            const tickers = {
                '台積電': '2330.TW',
                '富邦印度': '00652.TW',
                '永豐ESG': '00930.TW',
                '聯發科': '2454.TW',
                '元大美債20年': '00679B.TWO',
                '台灣大盤指數': '^TWII'
            };

            // 監聽選擇變更
            $('#interval-selection, #stock-ticker, #indicator-selection, #date-range-selection').on('change', function() {
                updateDashboard();
            });

            // 初始加載
            updateDashboard();

            function updateDashboard() {
                const interval = $('#interval-selection').val();
                const ticker = $('#stock-ticker').val();
                const selectedIndicators = $('#indicator-selection').val() || [];
                const dateRange = $('#date-range-selection').val();

                fetch(`data/stock_data.json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 根據選擇的股票和日期範圍過濾數據
                        let filteredData = filterData(data, ticker, dateRange, interval);
                        if (filteredData.length === 0) {
                            alert('沒有符合條件的數據。');
                            return;
                        }

                        // 更新表格
                        updateTable(filteredData);

                        // 更新圖表
                        updateCharts(filteredData, selectedIndicators);

                        // 更新今日狀態
                        updateTodayStatus(data, tickers);
                    })
                    .catch(error => {
                        console.error('無法加載數據:', error);
                        alert('無法加載數據。請檢查控制台以獲取更多信息。');
                    });
            }

            function filterData(data, ticker, dateRange, interval) {
                // 過濾特定股票
                let tickerData = data.filter(entry => entry.ticker === ticker);

                if (tickerData.length === 0) {
                    return [];
                }

                // 解析日期並排序
                tickerData.forEach(entry => {
                    entry.Date = new Date(entry.Date);
                });
                tickerData.sort((a, b) => a.Date - b.Date);

                // 根據日期範圍過濾
                const today = new Date();
                let startDate = new Date(today); // 創建 today 的副本
                switch(dateRange) {
                    case '2m':
                        startDate.setMonth(startDate.getMonth() - 2);
                        break;
                    case '6m':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '3y':
                        startDate.setFullYear(startDate.getFullYear() - 3);
                        break;
                    case '1y':
                    default:
                        startDate.setFullYear(startDate.getFullYear() - 1);
                }

                // 過濾日期範圍
                tickerData = tickerData.filter(entry => entry.Date >= startDate && entry.Date <= today);

                // 根據 interval 過濾
                if (interval === '1wk') {
                    // 每週一取一筆數據
                    tickerData = tickerData.filter(entry => entry.Date.getDay() === 1); // 0=Sunday, 1=Monday, etc.
                } else if (interval === '60m') {
                    // 假設有更高頻率的數據，否則無法處理
                    // 目前數據為日線，忽略
                }
                // 其他間隔可以根據需要實現

                return tickerData;
            }

            function updateTable(data) {
                // 清空表格
                table.clear();

                // 獲取最新一筆數據
                const latestEntry = data[data.length - 1];
                const previousEntry = data[data.length - 2] || {};

                // 提取指標值
                const indicators = {
                    "MACD": latestEntry.MACD,
                    "RSI": latestEntry.RSI,
                    "SMA": latestEntry.SMA,
                    "EMA": latestEntry.EMA,
                    "BB High": latestEntry['BB High'],
                    "BB Low": latestEntry['BB Low'],
                    "K": latestEntry.K,
                    "D": latestEntry.D,
                    "Stochastic RSI": latestEntry['Stochastic RSI'],
                    "CCI": latestEntry.CCI,
                    "Williams %R": latestEntry['Williams %R'],
                    "ADX": latestEntry.ADX,
                    "Close Price": latestEntry.Close
                };

                // 評估信號
                const indicatorValues = evaluateSignals(indicators, latestEntry, previousEntry, data);

                // 遍歷指標並添加到表格
                indicatorValues.forEach(indicator => {
                    table.row.add([
                        indicator.Indicator,
                        indicator.Value,
                        indicator['Sell Signal'],
                        indicator['Buy Signal'],
                        indicator['Secondary Sell Signal'],
                        indicator['Secondary Buy Signal'],
                        indicator.Status, // 包含 span 元素或純文本
                        indicator['Secondary Status'] // 包含 span 元素或純文本
                    ]);
                });

                // 重新繪製表格
                table.draw();
            }

            function evaluateSignals(indicators, latestEntry, previousEntry, data) {
                const indicator_values = [];

                // MACD
                const macd = indicators["MACD"];
                const macd_signal = latestEntry.MACD_signal;
                let status_macd = "Wait";
                let secondary_status_macd = "Wait";
                let sell_signal_macd = "-";
                let buy_signal_macd = "-";

                if (macd > macd_signal) {
                    status_macd = "Buy";
                    secondary_status_macd = "Buy";
                    buy_signal_macd = "MACD > Signal";
                } else if (macd < macd_signal) {
                    status_macd = "Sell";
                    secondary_status_macd = "Sell";
                    sell_signal_macd = "MACD < Signal";
                }

                indicator_values.push({
                    "Indicator": "MACD",
                    "Value": macd !== null && macd !== undefined ? macd.toFixed(2) : '-',
                    "Sell Signal": sell_signal_macd,
                    "Buy Signal": buy_signal_macd,
                    "Secondary Sell Signal": sell_signal_macd,
                    "Secondary Buy Signal": buy_signal_macd,
                    "Status": `<span class="${statusClass_general(status_macd)}">${status_macd}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_macd)}">${secondary_status_macd}</span>`
                });

                // RSI
                const rsi = indicators["RSI"];
                let status_rsi = "Wait";
                let secondary_status_rsi = "Wait";
                let sell_signal_rsi = "-";
                let buy_signal_rsi = "-";

                if (rsi < 30) {
                    status_rsi = "Buy";
                    buy_signal_rsi = "< 30";
                }
                if (rsi < 40) {
                    secondary_status_rsi = "Buy";
                    buy_signal_rsi = "< 40";
                }
                if (rsi > 70) {
                    status_rsi = "Sell";
                    sell_signal_rsi = "> 70";
                }
                if (rsi > 60) {
                    secondary_status_rsi = "Sell";
                    sell_signal_rsi = "> 60";
                }

                indicator_values.push({
                    "Indicator": "RSI",
                    "Value": rsi !== null && rsi !== undefined ? rsi.toFixed(2) : '-',
                    "Sell Signal": sell_signal_rsi,
                    "Buy Signal": buy_signal_rsi,
                    "Secondary Sell Signal": sell_signal_rsi,
                    "Secondary Buy Signal": buy_signal_rsi,
                    "Status": `<span class="${statusClass_general(status_rsi)}">${status_rsi}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_rsi)}">${secondary_status_rsi}</span>`
                });

                // SMA
                const sma = indicators["SMA"];
                const close_price = indicators["Close Price"];
                let status_sma = "Wait";
                let secondary_status_sma = "Wait";
                let sell_signal_sma = "-";
                let buy_signal_sma = "-";

                if (close_price < sma) {
                    status_sma = "Buy";
                    secondary_status_sma = "Buy";
                    buy_signal_sma = `< ${sma.toFixed(2)}`;
                }
                if (close_price > sma) {
                    status_sma = "Sell";
                    secondary_status_sma = "Sell";
                    sell_signal_sma = `> ${sma.toFixed(2)}`;
                }

                indicator_values.push({
                    "Indicator": "SMA",
                    "Value": sma !== null && sma !== undefined ? sma.toFixed(2) : '-',
                    "Sell Signal": sell_signal_sma,
                    "Buy Signal": buy_signal_sma,
                    "Secondary Sell Signal": sell_signal_sma,
                    "Secondary Buy Signal": buy_signal_sma,
                    "Status": `<span class="${statusClass_general(status_sma)}">${status_sma}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_sma)}">${secondary_status_sma}</span>`
                });

                // EMA
                const ema = indicators["EMA"];
                let status_ema = "Wait";
                let secondary_status_ema = "Wait";
                let sell_signal_ema = "-";
                let buy_signal_ema = "-";

                if (close_price < ema) {
                    status_ema = "Buy";
                    secondary_status_ema = "Buy";
                    buy_signal_ema = `< ${ema.toFixed(2)}`;
                }
                if (close_price > ema) {
                    status_ema = "Sell";
                    secondary_status_ema = "Sell";
                    sell_signal_ema = `> ${ema.toFixed(2)}`;
                }

                indicator_values.push({
                    "Indicator": "EMA",
                    "Value": ema !== null && ema !== undefined ? ema.toFixed(2) : '-',
                    "Sell Signal": sell_signal_ema,
                    "Buy Signal": buy_signal_ema,
                    "Secondary Sell Signal": sell_signal_ema,
                    "Secondary Buy Signal": buy_signal_ema,
                    "Status": `<span class="${statusClass_general(status_ema)}">${status_ema}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(secondary_status_ema)}">${secondary_status_ema}</span>`
                });

                // BB High
                const bb_high = indicators["BB High"];
                let status_bb_high = "Wait";
                if (close_price > bb_high) {
                    status_bb_high = "Sell";
                } else if (close_price < bb_high) {
                    status_bb_high = "Buy";
                }

                indicator_values.push({
                    "Indicator": "BB High v.s Close Price",
                    "Value": close_price !== null && close_price !== undefined ? close_price.toFixed(2) : '-',
                    "Sell Signal": close_price > bb_high ? `> ${bb_high.toFixed(2)}` : "-",
                    "Buy Signal": close_price < bb_high ? `< ${bb_high.toFixed(2)}` : "-",
                    "Secondary Sell Signal": close_price > bb_high ? `> ${bb_high.toFixed(2)}` : "-",
                    "Secondary Buy Signal": close_price < bb_high ? `< ${bb_high.toFixed(2)}` : "-",
                    "Status": `<span class="${statusClass_general(status_bb_high)}">${status_bb_high}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_bb_high)}">${status_bb_high}</span>`
                });

                // BB Low
                const bb_low = indicators["BB Low"];
                let status_bb_low = "Wait";
                if (close_price < bb_low) {
                    status_bb_low = "Buy";
                } else if (close_price > bb_low) {
                    status_bb_low = "Sell";
                }

                indicator_values.push({
                    "Indicator": "BB Low v.s Close Price",
                    "Value": close_price !== null && close_price !== undefined ? close_price.toFixed(2) : '-',
                    "Sell Signal": close_price > bb_low ? `> ${bb_low.toFixed(2)}` : "-",
                    "Buy Signal": close_price < bb_low ? `< ${bb_low.toFixed(2)}` : "-",
                    "Secondary Sell Signal": close_price > bb_low ? `> ${bb_low.toFixed(2)}` : "-",
                    "Secondary Buy Signal": close_price < bb_low ? `< ${bb_low.toFixed(2)}` : "-",
                    "Status": `<span class="${statusClass_general(status_bb_low)}">${status_bb_low}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_bb_low)}">${status_bb_low}</span>`
                });

                // K
                const k = indicators["K"];
                let status_k = "Wait";
                if (k < 20) {
                    status_k = "Buy";
                } else if (k > 80) {
                    status_k = "Sell";
                }

                indicator_values.push({
                    "Indicator": "K",
                    "Value": k !== null && k !== undefined ? k.toFixed(2) : '-',
                    "Sell Signal": k > 80 ? "> 80" : "-",
                    "Buy Signal": k < 20 ? "< 20" : "-",
                    "Secondary Sell Signal": k > 70 ? "> 70" : "-",
                    "Secondary Buy Signal": k < 30 ? "< 30" : "-",
                    "Status": `<span class="${statusClass_general(status_k)}">${status_k}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_k)}">${status_k}</span>`
                });

                // D
                const d = indicators["D"];
                let status_d = "Wait";
                if (d < 20) {
                    status_d = "Buy";
                } else if (d > 80) {
                    status_d = "Sell";
                }

                indicator_values.push({
                    "Indicator": "D",
                    "Value": d !== null && d !== undefined ? d.toFixed(2) : '-',
                    "Sell Signal": d > 80 ? "> 80" : "-",
                    "Buy Signal": d < 20 ? "< 20" : "-",
                    "Secondary Sell Signal": d > 70 ? "> 70" : "-",
                    "Secondary Buy Signal": d < 30 ? "< 30" : "-",
                    "Status": `<span class="${statusClass_general(status_d)}">${status_d}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_d)}">${status_d}</span>`
                });

                // Stochastic RSI
                const stochastic_rsi = indicators["Stochastic RSI"];
                let status_stochastic_rsi = "Wait";
                if (stochastic_rsi < 20) {
                    status_stochastic_rsi = "Buy";
                } else if (stochastic_rsi > 80) {
                    status_stochastic_rsi = "Sell";
                }

                indicator_values.push({
                    "Indicator": "Stochastic RSI",
                    "Value": stochastic_rsi !== null && stochastic_rsi !== undefined ? stochastic_rsi.toFixed(2) : '-',
                    "Sell Signal": stochastic_rsi > 80 ? "> 80" : "-",
                    "Buy Signal": stochastic_rsi < 20 ? "< 20" : "-",
                    "Secondary Sell Signal": stochastic_rsi > 60 ? "> 60" : "-",
                    "Secondary Buy Signal": stochastic_rsi < 40 ? "< 40" : "-",
                    "Status": `<span class="${statusClass_general(status_stochastic_rsi)}">${status_stochastic_rsi}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_stochastic_rsi)}">${status_stochastic_rsi}</span>`
                });

                // CCI
                const cci = indicators["CCI"];
                let status_cci = "Wait";
                if (cci < -100) {
                    status_cci = "Buy";
                } else if (cci > 100) {
                    status_cci = "Sell";
                }

                indicator_values.push({
                    "Indicator": "CCI",
                    "Value": cci !== null && cci !== undefined ? cci.toFixed(2) : '-',
                    "Sell Signal": cci > 100 ? "> 100" : "-",
                    "Buy Signal": cci < -100 ? "< -100" : "-",
                    "Secondary Sell Signal": cci > 90 ? "> 90" : "-",
                    "Secondary Buy Signal": cci < -90 ? "< -90" : "-",
                    "Status": `<span class="${statusClass_general(status_cci)}">${status_cci}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_cci)}">${status_cci}</span>`
                });

                // Williams %R
                const williams_r = indicators["Williams %R"];
                let status_williams_r = "Wait";
                if (williams_r < -80) {
                    status_williams_r = "Buy";
                } else if (williams_r > -20) {
                    status_williams_r = "Sell";
                }

                indicator_values.push({
                    "Indicator": "Williams %R",
                    "Value": williams_r !== null && williams_r !== undefined ? williams_r.toFixed(2) : '-',
                    "Sell Signal": williams_r > -20 ? "> -20" : "-",
                    "Buy Signal": williams_r < -80 ? "< -80" : "-",
                    "Secondary Sell Signal": williams_r > -40 ? "> -40" : "-",
                    "Secondary Buy Signal": williams_r < -60 ? "< -60" : "-",
                    "Status": `<span class="${statusClass_general(status_williams_r)}">${status_williams_r}</span>`,
                    "Secondary Status": `<span class="${statusClass_general(status_williams_r)}">${status_williams_r}</span>`
                });

                // ADX
                const adx = indicators["ADX"];
                let status_adx = "Wait";
                if (adx > 25) {
                    status_adx = "Hot Trend";
                } else if (adx < 20) {
                    status_adx = "No Trend";
                } else {
                    status_adx = "Trend"; // 當 ADX 在 20 到 25 之間時，標記為 "Trend"
                }

                indicator_values.push({
                    "Indicator": "ADX",
                    "Value": adx !== null && adx !== undefined ? adx.toFixed(2) : '-',
                    "Sell Signal": "-",
                    "Buy Signal": "-",
                    "Secondary Sell Signal": "-",
                    "Secondary Buy Signal": "-",
                    "Status": status_adx !== "No Trend" ? `<span class="${statusClass_general(status_adx, 'ADX')}" data-sort="${status_adx}">${status_adx}</span>` : `${status_adx}`,
                    "Secondary Status": status_adx !== "No Trend" ? `<span class="${statusClass_general(status_adx, 'ADX')}" data-sort="${status_adx}">${status_adx}</span>` : `${status_adx}`
                });

                // Close Price
                const close_price_val = indicators["Close Price"];
                indicator_values.push({
                    "Indicator": "Close Price",
                    "Value": close_price_val !== null && close_price_val !== undefined ? close_price_val.toFixed(2) : '-',
                    "Sell Signal": "-",
                    "Buy Signal": "-",
                    "Secondary Sell Signal": "-",
                    "Secondary Buy Signal": "-",
                    "Status": "-",
                    "Secondary Status": "-"
                });

                return indicator_values;
            }

            // 輔助函數來獲取狀態類別
            function statusClass_general(status, indicator = "") {
                if (indicator === "ADX") {
                    switch(status) {
                        case 'Hot Trend':
                            return 'status-hot-trend';
                        case 'Trend':
                            return 'status-trend';
                        case 'No Trend':
                            return ''; // 無背景顏色
                        default:
                            return 'status-wait';
                    }
                } else {
                    switch(status.toLowerCase()) {
                        case 'buy':
                            return 'status-buy';
                        case 'sell':
                            return 'status-sell';
                        case 'wait':
                            return 'status-wait';
                        default:
                            return 'status-wait';
                    }
                }
            }

            function updateCharts(data, selectedIndicators) {
                // 準備數據
                const dates = data.map(entry => entry.Date.toISOString().split('T')[0]);
                const closePrices = data.map(entry => entry.Close);

                // 繪製收盤價圖表（左側）僅顯示折線
                let priceTraces = [{
                    x: dates,
                    y: closePrices,
                    type: 'scatter',
                    mode: 'lines',
                    name: '收盤價',
                    line: { color: '#17BECF' }
                }];

                // Plotly layout for price chart
                let priceLayout = {
                    title: '股票收盤價',
                    xaxis: { title: '日期' },
                    yaxis: { title: '價格 (TWD)' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // 繪製技術指標圖表（右側）
                let indicatorTraces = [];

                selectedIndicators.forEach(indicator => {
                    if (indicator === "MACD") {
                        const macd = data.map(entry => entry.MACD);
                        const macd_signal = data.map(entry => entry.MACD_signal);
                        indicatorTraces.push({
                            x: dates,
                            y: macd,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: macd_signal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD Signal',
                            line: { color: '#2ECC40' }
                        });
                    }
                    if (indicator === "RSI") {
                        const rsi = data.map(entry => entry.RSI);
                        indicatorTraces.push({
                            x: dates,
                            y: rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(70),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(30),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "SMA") {
                        const sma = data.map(entry => entry.SMA);
                        indicatorTraces.push({
                            x: dates,
                            y: sma,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'SMA',
                            line: { color: '#FFA500' }
                        });
                    }
                    if (indicator === "EMA") {
                        const ema = data.map(entry => entry.EMA);
                        indicatorTraces.push({
                            x: dates,
                            y: ema,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'EMA',
                            line: { color: '#800080' }
                        });
                    }
                    if (indicator === "BB High") {
                        const bb_high = data.map(entry => entry['BB High']);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_high,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB High',
                            line: { color: '#FFFF00' }
                        });
                    }
                    if (indicator === "BB Low") {
                        const bb_low = data.map(entry => entry['BB Low']);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_low,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Low',
                            line: { color: '#00FF00' }
                        });
                    }
                    if (indicator === "K") {
                        const k = data.map(entry => entry.K);
                        indicatorTraces.push({
                            x: dates,
                            y: k,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K',
                            line: { color: '#FF69B4' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "D") {
                        const d = data.map(entry => entry.D);
                        indicatorTraces.push({
                            x: dates,
                            y: d,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D',
                            line: { color: '#1E90FF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Stochastic RSI") {
                        const stochastic_rsi = data.map(entry => entry['Stochastic RSI']);
                        indicatorTraces.push({
                            x: dates,
                            y: stochastic_rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI',
                            line: { color: '#DC143C' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "CCI") {
                        const cci = data.map(entry => entry.CCI);
                        indicatorTraces.push({
                            x: dates,
                            y: cci,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI',
                            line: { color: '#00FFFF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Williams %R") {
                        const williams_r = data.map(entry => entry['Williams %R']);
                        indicatorTraces.push({
                            x: dates,
                            y: williams_r,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R',
                            line: { color: '#8B008B' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "ADX") {
                        const adx = data.map(entry => entry.ADX);
                        indicatorTraces.push({
                            x: dates,
                            y: adx,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'ADX',
                            line: { color: '#FFD700' }
                        });
                        // ADX signals can be more complex
                    }
                    if (indicator === "Close Price") {
                        const closePrices = data.map(entry => entry.Close);
                        indicatorTraces.push({
                            x: dates,
                            y: closePrices,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Close Price',
                            line: { color: '#FFFFFF', dash: 'dash' } // 使用虛線區分
                        });
                    }
                });

                // Plotly layout for indicator chart
                let indicatorLayout = {
                    title: '技術指標',
                    xaxis: { title: '日期' },
                    yaxis: { title: '值' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // 繪製收盤價圖表
                Plotly.newPlot('price-chart', priceTraces, priceLayout);

                // 繪製技術指標圖表
                if (indicatorTraces.length > 0) {
                    Plotly.newPlot('indicator-chart', indicatorTraces, indicatorLayout);
                } else {
                    // 如果未選擇任何指標，顯示空白或提示
                    Plotly.purge('indicator-chart');
                    Plotly.newPlot('indicator-chart', [], indicatorLayout);
                }
            }

            function updateTodayStatus(data, tickers) {
                // 清空現有狀態
                $('#today-status').empty();

                const todayStatuses = [];

                Object.keys(tickers).forEach(name => {
                    const ticker = tickers[name];
                    const tickerData = data.filter(entry => entry.ticker === ticker);
                    if (tickerData.length === 0) {
                        todayStatuses.push(`
                            <div class="col-md-2 col-sm-6 stock-status">
                                <p style="font-weight:bold; font-size:18px;">${name}</p>
                                <p>No data available</p>
                            </div>
                        `);
                        return;
                    }

                    const latestEntry = tickerData[tickerData.length - 1];
                    const previousEntry = tickerData[tickerData.length - 2] || {};

                    const latestClose = parseFloat(latestEntry.Close);
                    const previousClose = previousEntry.Close !== null && previousEntry.Close !== undefined ? parseFloat(previousEntry.Close) : latestClose;
                    const change = latestClose - previousClose;
                    const changePercent = ((change) / previousClose) * 100;

                    let color, changeText, changeAmount;
                    if (change > 0) {
                        color = 'lightcoral'; // 淡紅色
                        changeText = `↑ ${changePercent.toFixed(2)}%`;
                        changeAmount = `+${change.toFixed(2)}`;
                    } else if (change < 0) {
                        color = 'lightgreen'; // 淡綠色
                        changeText = `↓ ${Math.abs(changePercent).toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    } else {
                        color = 'white';
                        changeText = `${changePercent.toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    }

                    todayStatuses.push(`
                        <div class="col-md-2 col-sm-6 stock-status">
                            <p style="font-weight:bold; font-size:18px;">${name}</p>
                            <p>股價: $${latestClose.toFixed(2)}</p>
                            <p style="color:${color};">${changeAmount}</p>
                            <p style="color:${color};">${changeText}</p>
                        </div>
                    `);
                });

                $('#today-status').html(`
                    <div class="w-100 d-flex justify-content-center flex-wrap">
                        ${todayStatuses.join('')}
                    </div>
                `);
            }
        });
    </script>
</body>
</html>