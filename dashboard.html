<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位儀表板</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <!-- 引入自定義 CSS -->
    <link href="assets/styles.css" rel="stylesheet">
    <style>
        body {
            background-color: #000; /* 黑色背景 */
            color: white; /* 白色字體 */
        }
        .stock-status {
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            width: 18%;
            background-color: #222;
        }
        .dataTables_wrapper .dataTables_filter input {
            color: black; /* 搜索框字體顏色 */
        }
        .indicator-table th, .indicator-table td {
            background-color: #333;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 回首頁按鈕 -->
        <div class="row mt-3">
            <div class="col-12 text-right">
                <a href="index.html" class="btn btn-primary">回首頁</a>
            </div>
        </div>

        <!-- 標題 -->
        <div class="row mt-4">
            <div class="col-12">
                <h1 class="text-center text-primary">Stock Dashboard</h1>
            </div>
        </div>

        <!-- 今日狀態 -->
        <div class="row mt-4" id="today-status">
            <!-- 動態生成的股票狀態將插入在這裡 -->
        </div>

        <!-- 表格 -->
        <div class="row mt-4">
            <div class="col-12">
                <table id="indicators-table" class="table table-striped table-bordered indicator-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Value</th>
                            <th>Sell Signal</th>
                            <th>Buy Signal</th>
                            <th>Secondary Sell Signal</th>
                            <th>Secondary Buy Signal</th>
                            <th>Status</th>
                            <th>Secondary Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 動態生成的表格數據將插入在這裡 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 選擇區域 -->
        <div class="row mt-4">
            <div class="col-md-3 mb-3">
                <select id="interval-selection" class="form-control">
                    <option value="60m">60分鐘線</option>
                    <option value="1d" selected>日線</option>
                    <option value="1wk">週線</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="stock-ticker" class="form-control">
                    <option value="2330.TW">台積電</option>
                    <option value="00652.TW">富邦印度</option>
                    <option value="00930.TW">永豐ESG</option>
                    <option value="2454.TW">聯發科</option>
                    <option value="2303.TW">聯電</option>
                    <option value="^TWII">台灣大盤指數</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="indicator-selection" class="form-control" multiple>
                    <option value="MACD">MACD (Moving Average Convergence Divergence)</option>
                    <option value="RSI">RSI (Relative Strength Index)</option>
                    <option value="SMA">SMA (Simple Moving Average)</option>
                    <option value="EMA">EMA (Exponential Moving Average)</option>
                    <option value="BB High">BB High (布林帶上軌)</option>
                    <option value="BB Low">BB Low (布林帶下軌)</option>
                    <option value="K">K (Stochastic Oscillator)</option>
                    <option value="D">D (Stochastic Oscillator)</option>
                    <option value="Stochastic RSI">Stochastic RSI</option>
                    <option value="CCI">CCI (Commodity Channel Index)</option>
                    <option value="Williams %R">Williams %R</option>
                    <option value="ADX">ADX (Average Directional Index)</option>
                    <option value="Close">Close Price</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="date-range-selection" class="form-control">
                    <option value="2m">近兩個月</option>
                    <option value="6m">近半年</option>
                    <option value="1y" selected>近一年</option>
                    <option value="3y">近三年</option>
                </select>
            </div>
        </div>

        <!-- 圖表 -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div id="price-chart"></div>
            </div>
            <div class="col-md-6 mb-4">
                <div id="indicator-chart"></div>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 引入 DataTables.js -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
    <!-- 引入 Bootstrap JS 和依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- 引入 Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- 引入自定義 JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 DataTable
            var table = $('#indicators-table').DataTable({
                "paging": false,
                "info": false,
                "autoWidth": false,
                "order": []
            });

            // 股票代碼映射
            const tickers = {
                '台積電': '2330.TW',
                '富邦印度': '00652.TW',
                '永豐ESG': '00930.TW',
                '聯發科': '2454.TW',
                '聯電': '2303.TW',
                '台灣大盤指數': '^TWII'
            };

            // 指標選項
            const indicatorsOptions = [
                "MACD",
                "RSI",
                "SMA",
                "EMA",
                "BB High",
                "BB Low",
                "K",
                "D",
                "Stochastic RSI",
                "CCI",
                "Williams %R",
                "ADX",
                "Close"
            ];

            // 監聽選擇變更
            $('#interval-selection, #stock-ticker, #indicator-selection, #date-range-selection').on('change', function() {
                updateDashboard();
            });

            // 初始加載
            updateDashboard();

            function updateDashboard() {
                const interval = $('#interval-selection').val();
                const ticker = $('#stock-ticker').val();
                const selectedIndicators = $('#indicator-selection').val() || [];
                const dateRange = $('#date-range-selection').val();

                fetch(`data/stock_data.json`)
                    .then(response => response.json())
                    .then(data => {
                        // 根據選擇的股票和日期範圍過濾數據
                        let filteredData = filterData(data, ticker, dateRange, interval);
                        if (filteredData.length === 0) {
                            alert('沒有符合條件的數據。');
                            return;
                        }

                        // 更新表格
                        updateTable(filteredData);

                        // 更新圖表
                        updateCharts(filteredData, selectedIndicators);

                        // 更新今日狀態
                        updateTodayStatus(data, tickers);
                    })
                    .catch(error => {
                        console.error('無法加載數據:', error);
                        alert('無法加載數據。');
                    });
            }

            function filterData(data, ticker, dateRange, interval) {
                // 過濾特定股票
                let tickerData = data.filter(entry => entry.ticker === ticker);

                if (tickerData.length === 0) {
                    return [];
                }

                // 解析日期並排序
                tickerData.forEach(entry => {
                    entry.Date = new Date(entry.Date);
                });
                tickerData.sort((a, b) => a.Date - b.Date);

                // 根據日期範圍過濾
                const today = new Date();
                let startDate = new Date(today); // 創建 today 的副本
                switch(dateRange) {
                    case '2m':
                        startDate.setMonth(startDate.getMonth() - 2);
                        break;
                    case '6m':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '1y':
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                    case '3y':
                        startDate.setFullYear(startDate.getFullYear() - 3);
                        break;
                    default:
                        startDate.setFullYear(startDate.getFullYear() - 1);
                }

                // 過濾日期範圍
                tickerData = tickerData.filter(entry => entry.Date >= startDate && entry.Date <= today);

                // 根據 interval 過濾
                if (interval === '1wk') {
                    // 每週一取一筆數據
                    tickerData = tickerData.filter(entry => entry.Date.getDay() === 1); // 0=Sunday, 1=Monday, etc.
                } else if (interval === '60m') {
                    // 假設有更高頻率的數據，否則無法處理
                    // 目前數據為日線，忽略
                }
                // 其他間隔可以根據需要實現

                return tickerData;
            }

            function updateTable(data) {
                // 清空表格
                table.clear();

                // 獲取最新一筆數據
                const latestEntry = data[data.length - 1];

                // 定義指標列表和對應的值
                const indicators = {
                    "MACD": latestEntry.MACD,
                    "RSI": latestEntry.RSI,
                    "SMA": latestEntry.SMA,
                    "EMA": latestEntry.EMA,
                    "BB High": latestEntry['BB High'],
                    "BB Low": latestEntry['BB Low'],
                    "K": latestEntry.K,
                    "D": latestEntry.D,
                    "Stochastic RSI": latestEntry['Stochastic RSI'],
                    "CCI": latestEntry.CCI,
                    "Williams %R": latestEntry['Williams %R'],
                    "ADX": latestEntry.ADX,
                    "Close Price": latestEntry.Close
                };

                // 遍歷指標並添加到表格
                for (const [indicator, value] of Object.entries(indicators)) {
                    // 將數值格式化為兩位小數，或顯示 '-' 如果為 null
                    const formattedValue = value !== null && value !== undefined ? parseFloat(value).toFixed(2) : '-';

                    // 根據指標類型設定信號和狀態
                    // 這部分可以根據具體需求調整
                    let sellSignal = '-', buySignal = '-', secondarySellSignal = '-', secondaryBuySignal = '-', status = '-', secondaryStatus = '-';

                    // 示例：根據 RSI 值設定買賣信號
                    if (indicator === "RSI") {
                        if (value < 30) {
                            buySignal = "< 30";
                            status = "Buy";
                        } else if (value > 70) {
                            sellSignal = "> 70";
                            status = "Sell";
                        }
                    }

                    // 根據 MACD 值設定信號
                    if (indicator === "MACD") {
                        if (value > latestEntry['MACD_signal']) {
                            buySignal = "MACD > Signal";
                            status = "Buy";
                        } else if (value < latestEntry['MACD_signal']) {
                            sellSignal = "MACD < Signal";
                            status = "Sell";
                        }
                    }

                    // 其他指標的信號可以類似處理

                    table.row.add([
                        indicator,
                        formattedValue,
                        sellSignal,
                        buySignal,
                        secondarySellSignal,
                        secondaryBuySignal,
                        status,
                        secondaryStatus
                    ]);
                }

                // 重新繪製表格
                table.draw();
            }

            function updateCharts(data, selectedIndicators) {
                // 準備數據
                const dates = data.map(entry => entry.Date.toISOString().split('T')[0]);
                const closePrices = data.map(entry => entry.Close);

                // Initialize price figure
                let priceTraces = [{
                    x: dates,
                    y: closePrices,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: '收盤價',
                    line: { color: '#17BECF' }
                }];

                // Plotly layout for price chart
                let priceLayout = {
                    title: '股票收盤價',
                    xaxis: { title: '日期' },
                    yaxis: { title: '價格 (TWD)' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // Initialize indicator traces
                let indicatorTraces = [];

                selectedIndicators.forEach(indicator => {
                    if (indicator === "MACD") {
                        const macd = data.map(entry => entry.MACD);
                        const macd_signal = data.map(entry => entry.MACD_signal);
                        indicatorTraces.push({
                            x: dates,
                            y: macd,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: macd_signal,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD Signal',
                            line: { color: '#2ECC40' }
                        });
                    }
                    if (indicator === "RSI") {
                        const rsi = data.map(entry => entry.RSI);
                        indicatorTraces.push({
                            x: dates,
                            y: rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI',
                            line: { color: '#FF5733' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(70),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(30),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "SMA") {
                        const sma = data.map(entry => entry.SMA);
                        indicatorTraces.push({
                            x: dates,
                            y: sma,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'SMA',
                            line: { color: '#FFA500' }
                        });
                    }
                    if (indicator === "EMA") {
                        const ema = data.map(entry => entry.EMA);
                        indicatorTraces.push({
                            x: dates,
                            y: ema,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'EMA',
                            line: { color: '#800080' }
                        });
                    }
                    if (indicator === "BB High") {
                        const bb_high = data.map(entry => entry['BB High']);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_high,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB High',
                            line: { color: '#FFFF00' }
                        });
                    }
                    if (indicator === "BB Low") {
                        const bb_low = data.map(entry => entry['BB Low']);
                        indicatorTraces.push({
                            x: dates,
                            y: bb_low,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Low',
                            line: { color: '#00FF00' }
                        });
                    }
                    if (indicator === "K") {
                        const k = data.map(entry => entry.K);
                        indicatorTraces.push({
                            x: dates,
                            y: k,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K',
                            line: { color: '#FF69B4' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'K Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "D") {
                        const d = data.map(entry => entry.D);
                        indicatorTraces.push({
                            x: dates,
                            y: d,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D',
                            line: { color: '#1E90FF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'D Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Stochastic RSI") {
                        const stochastic_rsi = data.map(entry => entry['Stochastic RSI']);
                        indicatorTraces.push({
                            x: dates,
                            y: stochastic_rsi,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI',
                            line: { color: '#DC143C' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stochastic RSI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "CCI") {
                        const cci = data.map(entry => entry.CCI);
                        indicatorTraces.push({
                            x: dates,
                            y: cci,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI',
                            line: { color: '#00FFFF' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-100),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'CCI Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "Williams %R") {
                        const williams_r = data.map(entry => entry['Williams %R']);
                        indicatorTraces.push({
                            x: dates,
                            y: williams_r,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R',
                            line: { color: '#8B008B' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-20),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Overbought',
                            line: { dash: 'dashdot', color: 'red' }
                        });
                        indicatorTraces.push({
                            x: dates,
                            y: Array(dates.length).fill(-80),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Williams %R Oversold',
                            line: { dash: 'dashdot', color: 'green' }
                        });
                    }
                    if (indicator === "ADX") {
                        const adx = data.map(entry => entry.ADX);
                        indicatorTraces.push({
                            x: dates,
                            y: adx,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'ADX',
                            line: { color: '#FFD700' }
                        });
                        // ADX signals can be more complex
                    }
                    if (indicator === "Close") {
                        // 已在價格圖表中繪製
                        // 如果需要，可以添加另一條線
                    }
                });

                // Plotly layout for indicator chart
                let indicatorLayout = {
                    title: '技術指標',
                    xaxis: { title: '日期' },
                    yaxis: { title: '值' },
                    template: 'plotly_dark',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0)',
                    font: { color: 'white' },
                    hovermode: 'x unified'
                };

                // Combine all traces
                let allTraces = [...indicatorTraces];

                // 創建技術指標圖表
                Plotly.newPlot('indicator-chart', allTraces, indicatorLayout);
            }

            function updateTodayStatus(data, tickers) {
                // 清空現有狀態
                $('#today-status').empty();

                const todayStatuses = [];

                Object.keys(tickers).forEach(name => {
                    const ticker = tickers[name];
                    const tickerData = data.filter(entry => entry.ticker === ticker);
                    if (tickerData.length === 0) {
                        todayStatuses.push(`
                            <div class="stock-status">
                                <p style="font-weight:bold; font-size:18px; text-align:center;">${name}</p>
                                <p>No data available</p>
                            </div>
                        `);
                        return;
                    }

                    const latestEntry = tickerData[tickerData.length - 1];
                    const previousEntry = tickerData[tickerData.length - 2] || {};

                    const latestClose = parseFloat(latestEntry.Close);
                    const previousClose = previousEntry.Close !== null ? parseFloat(previousEntry.Close) : latestClose;
                    const change = latestClose - previousClose;
                    const changePercent = ((change) / previousClose) * 100;

                    let color, changeText, changeAmount;
                    if (change > 0) {
                        color = 'lightcoral'; // 淡紅色
                        changeText = `↑ ${changePercent.toFixed(2)}%`;
                        changeAmount = `+${change.toFixed(2)}`;
                    } else if (change < 0) {
                        color = 'lightgreen'; // 淡綠色
                        changeText = `↓ ${Math.abs(changePercent).toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    } else {
                        color = 'white';
                        changeText = `${changePercent.toFixed(2)}%`;
                        changeAmount = `${change.toFixed(2)}`;
                    }

                    todayStatuses.push(`
                        <div class="stock-status">
                            <p style="font-weight:bold; font-size:18px; text-align:center;">${name}</p>
                            <p>股價: $${latestClose.toFixed(2)}</p>
                            <p style="color:${color};">${changeAmount}</p>
                            <p style="color:${color};">${changeText}</p>
                        </div>
                    `);
                });

                $('#today-status').html(`
                    <div class="d-flex flex-wrap justify-content-center">
                        ${todayStatuses.join('')}
                    </div>
                `);
            }
        });
    </script>
</body>
</html>